---
title-block: false
date-format: "DD-MM-YYYY"
description: "Dam database"
number-sections: true
format: 
  pdf:
    documentclass : report
    include-in-header:  
      - text: |
            \usepackage{tikz}
    include-before-body: dam_header.tex
    toc: true
    toc-depth: 3
    toc-title: Contents
    number-sections: true
    colorlinks: true    
    use-rsvg-convert: false
    pdf-engine-opts: ["-shell-escape"]
execute: 
 keep-md: false
filters:
  - include-code-files
reference-location: document
bibliography: diaspara_dam.bib
editor: 
  markdown: 
    wrap: 72
---




```{r init}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE
#| results: 'hide'

#if (!grepl("montepomi", getwd())) {
if(Sys.info()[["user"]] == 'joliviero'){
setwd("D:/workspace/DIASPARA_WP3_dam/R")
datawd <- "D:/DIASPARA/wgbast"
} else if (Sys.info()[["user"]] == 'cedric.briand'){
setwd("C:/workspace/DIASPARA_WP3_dam/R")
datawd <- "C:/Users/cedric.briand/OneDrive - EPTB Vilaine/Projets/DIASPARA/"
}
source("utilities/load_library.R")

load_library("tidyverse")
load_library("knitr")
load_library("kableExtra")
load_library("icesVocab")
load_library("readxl")
load_library("janitor")
load_library("skimr")
load_library("RPostgres")
load_library("yaml")
load_library("DBI")
load_library("ggplot2")
load_library("sf")
load_library("janitor") #
load_library("htmltools") 
load_library("leaflet")
load_library("flextable")
load_library("ftExtra")
# set_flextable_defaults(
#   font.size = 8.5, font.family = "Calibri",
#   font.color = "black",
#   table.layout = "autofit",
#   border.color = "black",
#   padding.top = 3, padding.bottom = 3,
#   padding.left = 4, padding.right = 4)
cred <- read_yaml("../credentials.yml")
# con_diaspara <- dbConnect(Postgres(), 
#                            dbname = cred$dbnamehydro,
#                            host = cred$hostmercure,
#                            port = cred$port,
#                            user = cred$usermercure,
#                            password = cred$passwordmercure)
con_diaspara <- dbConnect(Postgres(), 
                          dbname = cred$dbnamediaspara,
                          host = cred$hostdistant,
                          port = cred$port,
                          user = cred$userdiaspara,
                          password = cred$passworddiaspara)
con_diaspara_admin <- dbConnect(Postgres(), 
                                dbname = cred$dbnamediaspara,
                                host = cred$hostdistant,
                                port = cred$port,
                                user = cred$userdistant,
                                password = cred$passworddistant)
```

Foreword : this document is best viewed on the [diaspara website](https://diaspara.bordeaux-aquitaine.inrae.fr/deliverables/wp3/p16dam/rep16.html) in html

# Introduction

River fragmentation induced by human obstacles is a main threat to diadromous 
species. By impairing their migrations in rivers, they hinder their access to 
critical growth or reproduction habitats and potentially impair the achievement
of their life cycle. Turbines at hydropower stations, pumps are also a direct
source of mortality of fish during their downstream migration, or their move within the rivers. 

In view of this and in a context of an ecosystem approach of fisheries management,
there is a clear need to account for the impact of obstacles on the status of the
species and to develop tools to prioritize restoration actions. To do so, a prerequisite
is the availability of data on the location of dams as well as a set of 
characteristics related to their impacts, but those data are scattered, not easily
available and not standardised.

This database proposes a database structure that could be used to collect and store
a minimal set of data across Europe to quantify the impact of dams and weirs on 
diadromous fish stocks. 

The work is based on an the DBEEL data database from the 
the POSE project [@walker_pilot_2011] that was developed to handle all threats
for eel, and was latter extended  during the (SUDOANG project)[https://sudoang.eu/en].
Here, we develop a simplified elements by removing all elements that were judged not necessary in the
database structure to answer the core of the question. This simplification is critical
to then simplify the data collection at a large spatial scale. The code of the table in the national database is provided.



# Obstruction place

Each dam is characterized by a location which forms the top table (obstruction_place) (@fig-dam_db_op). 
For some complex river systems (braided rivers, branches ...) it is sometimes necessary to link the dams
together, thereby identifying the main dam structure used to calculate cumulated impact.
Indeed if two dams are in two parallel branches of the river, for upstream migration the cumulated impact is only based on
the height and characteristics of the main dam as otherwise we would enter similar height twice. For downstream migration, the flow is split within the dam complex, using the main dam, and
all dams attached to it.

![Obstruction place](images/obstruction_place.png){#fig-dam_db_op fig-alt="The location of the table obstruction place within a MPD diagram" .lightbox width=80%}

**Inherited tables**

To handle the updates of data, the database uses inheritance. The data are entered
in the country schema, in this schema all tables inherit from the tables in the main
dam schema (@fig-dam_db_opin). When updates are collected, one can simply
upload all tables again in the country schema. Other columns can be added at the national R/Diaspara_WP3.3_dam_report_html.qmd level to collect additional information. 
![Obstruction place inheritance](images/obstruction_place_inheritance.png){#fig-dam_db_opin fig-alt="Diagram Illustrating how the tables from several countries (child tables) link to the main (mother) table"}

Currently the data reporters is identified in EDMO (European Directory of Marine Organisations) (Table @tbl-icesEDMO),
as for the first datacall the source of data will probably be the institute reporting at the national level. The development
of a dam database in the Environment Agency will probably change this.

```{r}
#| label: tbl-icesEDMO
#| echo: TRUE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| code-fold: TRUE
#| code-summary: Code to show EDMO.
#| tbl-cap: European Directory of Marine Organisations (EDMO)


EDMO <- getCodeList("EDMO")|>
slice_head(n=10)  |>
flextable() |>
  bold(bold = TRUE, part = "header") |>
  autofit() |>
  theme_booktabs(x, bold_header = FALSE) 
EDMO
```

The obstruction place table is illustrated in Table @tbl-obstruction_place.

```{r}
#| label: tbl-obstruction_place
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| code-summary: Code to show EDMO.
#| tbl-cap: Dam obstruction place table

# save(dam, file="data/presentation_dam_op.Rdata")
load(file="data/presentation_dam_op.Rdata")
dam |> 
slice_head(n=20)  |>
knitr::kable() |>
kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

![Map of a subset of dams in France](images/fig-obstruction_place.png){fig-alt="A screenshot of the leaflet showing in html report" #fig-obstruction_place  width=80%}

# Physical obstruction

This table (@tbl-obstruction) is linked to the physical location of the dam and store meta-data on the dam characteristics.

It can be summarized as following :

- Physical obstruction has date of start and end

- Any changes are linked to Events (Erasement, change of height change dam period)

- There might be several fishway types

- It includes information on downstream water depth (a key parameter to assess the passability of an obstacle)

![Simplified structure of the dam database, the physical obstruction](images/fig-physical_obstruction.png){fig-alt="Diagram showing the physical obstruction table relation with others" #fig-physical_obstruction  width=80%}

```{r}
#| label: tbl-obstruction
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| tbl-cap: Dam physical obstruction table 


# dam_ob <-dbGetQuery(con_diaspara, "SELECT 
# * FROM dam_france.obstruction limit 100;")

# save(dam_ob, file="data/presentation_dam_ob.Rdata")
load(file="data/presentation_dam_ob.Rdata")

 dam_ob |> 
 slice_head(n=20)  |>
 knitr::kable() |>
kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

# Assessment of passability

The table (@tbl-fishway) is called fishway but in practise refers to fish passage, as it evaluates for each species whether the dam is passable, and this is often related to an expertise of fishway type. Basically it says whether a fishway is efficient for each species, a fishway designed for Salmon might not be suitable for Shad (@fig-dam_db_fp).

![Simplied structure of the dam database, assessment of passability](images/fig-dam_db_fp.png){fig-alt="Diagram showing how the passability table relates to other" #fig-dam_db_fp  width=80%}



```{r}
#| label: tbl-fishway
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| html-table-processing: none


 dam_fi <-dbGetQuery(con_diaspara, "SELECT 
 fi_id_original, 
 species.no_name,
 fi_presence_pass,
 fi_date
  FROM dam_france.fishway  
  JOIN nomenclature.species on species.no_id=fi_species_id
  limit 100;")

 save(dam_fi, file="data/presentation_dam_fi.Rdata")
load(file="data/presentation_dam_fi.Rdata")

 dam_fi |> 
  slice_head(n=20)  |>
 knitr::kable() |>
kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

# Hydro Power Plants

The elements in hydro power plants  (@fig-dam_db_hp, @tbl-hpp)  are necessary to make a calculation of the mortality
at the dam level, according to the type of turbine, equipment flow and scenarios of flows at migration (see
deliverable d2.2.1 from sudoang here https://sudoang.eu/wp-content/uploads/2021/04/Deliverables-2-1-1_2-2-3-French-2.pdf).

![Simplied structure of the dam database, hydro power plants](images/fig-dam_db_hp.png){fig-alt="Diagram showing how the hydropower plant table relates to other" #fig-dam_db_hp  width=80%}



```{r}
#| label: tbl-hpp
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| html-table-processing: none
#| tbl-cap: Hydropower plant table


#  dam_hpp <-dbGetQuery(con_diaspara, "SELECT 
#  *
#   FROM dam_france.hpp   
#   limit 100;")

#  save(dam_hpp, file="data/presentation_dam_hpp.Rdata")
load(file="data/presentation_dam_hpp.Rdata")

 dam_hpp |>  
 slice_head(n=20)  |>
 knitr::kable() |>
kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```

# Turbines

In addition to the data stored in the hydropower plant (@fig-dam_db_hp), the turbine
database store key characteristics of turbines that control the level of induced
mortality.

![Simplied structure of the dam database, Turbine table](images/fig-dam_db_tu.png){fig-alt="Diagram showing how the hydropower plant table relates to other" #fig-dam_db_tu  width=80%}



```{r}
#| label: tbl-turbines
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| html-table-processing: none
#| tbl-cap: Turbine table


#  dam_turb <-dbGetQuery(con_diaspara, "SELECT 
#  *
#   FROM dam_france.turbine  
#   limit 100;")

#  save(dam_turb, file="data/presentation_dam_turb.Rdata")
load(file="data/presentation_dam_turb.Rdata")

 dam_turb |> 
  slice_head(n=20)  |>
 knitr::kable() |>
kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```


```{r}
#| label: tbl-turbines_type
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| tbl-cap: Turbine type table


#  turb_type <-dbGetQuery(con_diaspara, "SELECT 
#  *
#   FROM nomenclature.turbine_type;")

#  save(turb_type, file="data/presentation_turb_type.Rdata")
load(file="data/presentation_turb_type.Rdata")

 turb_type |> 
 knitr::kable() |>
kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

# Annex 1 : sql code users

<details>

<summary>SQL code to create user rights </summary>

``` {.sql include="../SQL/1_users.sql"}
```

</details>






# Annex 2 : Nomenclature tables

The nomenclature has been adapted to the DIASPARA project using the vocab in
stockDB.


<details>

<summary>SQL code to create nomenclature </summary>

``` {.sql include="../SQL/2_nomenclature_structure.sql"}
```

</details>


<details>

<summary>Data in nomenclature </summary>

``` {.sql include="../SQL/3_nomenclature_data.sql"}
```

</details>

```{r}
#| label: nomenclature
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| results: 'asis'

tables <- dbGetQuery(con_diaspara_admin,
"SELECT * FROM information_schema.tables 
WHERE table_schema = 'nomenclature'")$table_name
tables <- tables[-match("nomenclature",tables)]

for (tt in tables){
  tab <- dbGetQuery(con_diaspara, paste0("SELECT * FROM nomenclature.",tt))
  purrr::map_chr(
    .x = list(tab),  
    function(tab){
  knitr::knit_child(input = "Diaspara_WP3.3_dam_report_flextable_child_loop.Rmd", envir = environment(), quiet = TRUE)
    }) |> cat(sep = '\n')
}



```

# Annex 3 : Dam tables

The dam db was created from the dbeel using the following script.

<details>

<summary>SQL code to transfered from the DBEEL </summary>

``` {.sql include="../SQL/5_transfer_dbeel_dam_script.sql"}
```

</details>

The postgreSQL code for creating the table is as following

<details>

<summary>SQL code to create dam structure </summary>

``` {.sql include="../SQL/4_dam_structure.sql"}
```

</details>



# Annex 4 : Country dam table example


<details>

<summary>SQL code to create france schema </summary>

``` {.sql include="../SQL/6_france_schema.sql"}
```

</details>

<details>

<summary>SQL code to import france </summary>

``` {.sql include="../SQL/7_import_france_example.sql"}
```

</details>

# Annex 5 : Database ER diagram


![Entity Relationship database dam](images/ER_diagram.png){#fig-erd fig-alt="An entity relationship diagram for the dam database"}



Acknowledgements :
The Ecohydraulique pole in Toulouse, Pierre Sagnes for support with the
data and developping things during SUDOANG.  Karl Kreuztenberger, for
providing the various dumps to the french tables.
