---
title: "Dam database"
subtitle: "DIASPARA WP3.3 pre-release"
author: "Briand CÃ©dric, Oliviero Jules, Helminen Jani"
date-format: "DD-MM-YYYY"
description: "Structure and examples for the dam database"
title-block-banner: "images/diaspara_bandeau.png"
title-block-banner-color: "white"
format:
 html:
  self-contained: true
  theme: styles.scss
  smooth-scroll: true
  fontcolor: black
  toc: true
  toc-location: left
  toc-title: Contents
  toc-depth: 3
execute: 
 keep-md: true
filters:
  - include-code-files
reference-location: document
include-after-body: "footer.html"
bibliography: diaspara_dam.bib
editor: 
  markdown: 
    wrap: 72
---

```{r init}
#| echo: FALSE
#| warning: FALSE
#| message: FALSE
#| results: 'hide'

#if (!grepl("montepomi", getwd())) {
if(Sys.info()[["user"]] == 'joliviero'){
setwd("D:/workspace/DIASPARA_WP3_dam/R")
datawd <- "D:/DIASPARA/wgbast"
} else if (Sys.info()[["user"]] == 'cedric.briand'){
setwd("C:/workspace/DIASPARA_WP3_dam/R")
datawd <- "C:/Users/cedric.briand/OneDrive - EPTB Vilaine/Projets/DIASPARA/"
}
source("utilities/load_library.R")

load_library("tidyverse")
load_library("knitr")
load_library("kableExtra")
load_library("icesVocab")
load_library("readxl")
load_library("janitor")
load_library("skimr")
load_library("RPostgres")
load_library("yaml")
load_library("DBI")
load_library("ggplot2")
load_library("sf")
load_library("janitor") #
load_library("htmltools") 
load_library("leaflet")
load_library("flextable")
load_library("ftExtra")
# set_flextable_defaults(
#   font.size = 8.5, font.family = "Calibri",
#   font.color = "black",
#   table.layout = "autofit",
#   border.color = "black",
#   padding.top = 3, padding.bottom = 3,
#   padding.left = 4, padding.right = 4)
cred <- read_yaml("../credentials.yml")
# con_diaspara <- dbConnect(Postgres(), 
#                            dbname = cred$dbnamehydro,
#                            host = cred$hostmercure,
#                            port = cred$port,
#                            user = cred$usermercure,
#                            password = cred$passwordmercure)
con_diaspara <- dbConnect(Postgres(), 
                          dbname = cred$dbnamediaspara,
                          host = cred$hostdistant,
                          port = cred$port,
                          user = cred$userdiaspara,
                          password = cred$passworddiaspara)
con_diaspara_admin <- dbConnect(Postgres(), 
                                dbname = cred$dbnamediaspara,
                                host = cred$hostdistant,
                                port = cred$port,
                                user = cred$userdistant,
                                password = cred$passworddistant)
```

# Introduction
River fragmentation induced by human obstacles is a main threat to diadromous 
species. By impairing their migrations in rivers, they hinder their access to 
critical growth or reproduction habitats and potentially impair the achievement
the achievement of their life cycle. Turbin at hydropower station is also a direct
source of mortality of fish during their downstream migration. 

In view of this and in a context of an ecosystem approach of fisheries management,
there is a clear need to account for the impact of obstacles on the status of the
species and to develop tools to prioritize restoration actions. To do so, a prerequisite
is the availability of data on the location of dams as well as a set of 
characteristics related to their impacts, but those data are scattered, not easily
available and not standardised.

This database proposes a database structure that could be used to collect and store
a minimal set of data across Europe to quantify the impact of dams and weirs on 
diadromous fish stocks. 

The work is based on an the DBEEL data database from the 
the POSE project [@walker_pilot_2011] that was developed to handle all threats
for eel, and was latter extended  during the (SUDOANG project)[https://sudoang.eu/en].
Here, we develop a simplified elements by removing all elements that were judged not necessary in the
database structure to answer the core of the question. This simplification is critical
to then simplify the data collection at a large spatial scale. The code of the table in the national database is provided.



# Obstruction place

Each dam is characterized by a location which forms the top table (obstruction_place) (@fig-dam_db_op). 
For some complex river systems (braided rivers, branches ...) it is sometimes necessary to link the dams
together, identifying the main dam over which the cumulated height of dams will be calculated.{>>end of the sentence seems weird<<}

```{mermaid}
%%| label: fig-dam_db_op
%%| fig-cap: Simplied structure of the dam database
flowchart TB
    A([Obstruction place]):::main
    %% Short Path
    A --> B([Obstruction]):::table
    B -->|Upstream| F([fish passage]):::table
    B -->|Downstream| C([Hydro Power Plant]):::table
    C --> D([Turbine]):::table    
    classDef table fill:#CD88
    classDef main fill:#268073,color:white
```

**Inherited tables**

To handle the updates of data, the database uses inheritance. The data are entered
in the country schema, in this schema all tables inherit from the tables in the main
dam schema (@fig-dam_db_opin). When updates are collected, one can simply
upload all tables again in the country schema. Other columns can be added at the national R/Diaspara_WP3.3_dam_report_html.qmdlevel to collect additional information. 

```{mermaid}
%%| label: fig-dam_db_opin
%%| fig-cap: Inheritance in obstruction places tables
flowchart TB
    A([Obstruction place]):::table
    %% Short Path
    A --> B([Obstuction place FR]):::table
    A --> C([Obstuction place ES]):::table 
    A --> D([Obstuction place ...]):::table      
    classDef table fill:#CD88
    classDef main fill:#268073,color:white
```

The data reporters must be reported in EDMO (European Directory of Marine Organisations) (Table @tbl-icesEDMO). {>>I won't mention that: it depends where the database will finally be stored: not sure that EA uses EDMO for example. For me ICES is not the good candidate. Moreover, we are speaking of continental threats, so most data providers won't be in EDMO, asking them to register will create bottleneck, reluctance.<<}

```{r}
#| label: tbl-icesEDMO
#| echo: TRUE
#| eval: TRUE
#| warning: FALSE
#| message: FALSE
#| code-fold: TRUE
#| code-summary: Code to show EDMO.
#| tbl-cap: European Directory of Marine Organisations (EDMO)


EDMO <- getCodeList("EDMO")|>
slice_head(n=10)  |>
flextable() |>
  bold(bold = TRUE, part = "header") |>
  autofit() |>
  theme_booktabs(x, bold_header = FALSE) 
EDMO
```

The obstruction place table is illustrated in Table @tbl-obstruction_place.

```{r}
#| label: tbl-obstruction_place
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| html-table-processing: none


# dam <-dbGetQuery(con_diaspara, "SELECT 
# op_placename,
# op_op_id,
# op_id_original,
# op_country
#  FROM dam_france.obstruction_place limit 500;")

# save(dam, file="data/presentation_dam_op.Rdata")
load(file="data/presentation_dam_op.Rdata")

 dam |> 
 DT::datatable(rownames = FALSE,
  options = list(
    pageLength = 7,        
    scrollX= TRUE   
  )
) |>
  htmltools::tagList(
   

    tags$style(HTML("
      /* Table cells */
      table.dataTable td {
        font-size: 0.6em;
      }

      /* Table headers */
      table.dataTable th {
        font-size: 0.65em;
      }

      /* Control bar: search input, pagination, etc. */
      .dataTables_wrapper .dataTables_filter,
      .dataTables_wrapper .dataTables_length,
      .dataTables_wrapper .dataTables_info,
      .dataTables_wrapper .dataTables_paginate {
        font-size: 0.70em;
      }
    "))

  )

```


```{r}
#| label: fig-obstruction_place
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| fig-cap: "A subsample of the dam database in France"

# query <- "SELECT op_id_original,
#                  op_placename, 
#                  ob_height, 
#                  ot.no_code as type,                 
#                  geom 
#           FROM dam_france.obstruction_place op
#           JOIN dam_france.obstruction o
#              ON ob_op_id = op_id
#           JOIN nomenclature.obstruction_type ot
#              ON ob_obstruction_type_no_id = ot.no_id
#           JOIN refeel.tr_area_are are ON 
#           st_intersects(st_transform(op.geom, 4326), are.geom_polygon)
#           WHERE are_code = 'FR_Bret'
#           AND ob_ending_date = '2035-01-01'
#           "
# query2 <- "SELECT are1.are_id, are1.geom_line FROM refnas.tr_area_are are1 
#           JOIN refeel.tr_area_are are2 ON 
#           st_intersects(are1.geom_line, are2.geom_polygon)
#           WHERE are2.are_code = 'FR_Bret'
#           AND  are1.are_lev_code = 'River_section'"


# layer <- st_read(dsn = con_diaspara, query = query) |> 
#          sf::st_transform(4326) 
# layer_riv <- st_read(dsn = con_diaspara, query = query2) 



# save(layer, layer_riv, file = "data/dammap_presentation.Rdata")
load(file = "data/dammap_presentation.Rdata")
layer <- layer |>
          mutate(label = sprintf(
            '%s <br>	
             code: %s <br>
             type: %s <br>				
					   h: %1.2f,<br> ',
            stringi::stri_trans_general(layer$op_placename, "latin-ascii"),
            layer$op_id_original,
            layer$type,            
            layer$ob_height
          )) 
layer$size <-  1+log(layer$ob_height+1) #  range 1-13
layer$size[is.na(layer$size)] <- 0.01
layer$type[is.na(layer$type)]<-"NA"
layer$type <- as.factor(layer$type)
cols <- RColorBrewer::brewer.pal(length(levels(layer$type)),name ="Set1")
colorfun <- leaflet::colorFactor(cols, layer$type)


l <- leaflet::leaflet() |>
     leaflet::addPolylines(data= layer_riv, 
     opacity=0.5,
     fillOpacity = 0.2
     ) |>
     leaflet::addScaleBar(options = leaflet::scaleBarOptions(imperial = FALSE)) |>
     leaflet::addProviderTiles(leaflet::providers$CartoDB.DarkMatter) |>
     leaflet::addCircleMarkers(
        data = layer[1:500,],
        popup = ~label,
        color = ~colorfun(type),       
        radius = ~size       
      ) |>
      leaflet::addLegend(
        position="topright",
        colors = cols,
        labels = levels(layer$type),
        opacity = 1)
    
l

```

{>>in the caption, I think we should say that (i) it is not dam only but also weirs, (ii) we are plotting the locations, (iii) where the data come from<<}


# Physical obstruction

This table (@tbl-obstruction) is linked to the physical location of the dam and store meta-data on the dam itself.

It can be summarized as following :

- Physical obstruction has date of start and end

- Any changes are linked to Events (Erasement, change of height change dam period)

- There might be several fishway types

- It includes information on downstream water depth (a key parameter to assess the passability of an obstacle)

{>>if you mention fishway here, then we should mention turbin? the logic is the same for the two?<<}


```{mermaid}
%%| label: fig-physical_obstruction
%%| fig-cap: Simplified structure of the dam database, the physical obstruction 
flowchart TB
    A([Obstruction place]):::table
    %% Short Path
    A --> B([Obstruction]):::main
    B -->|Upstream| F([fish passage]):::table
    B -->|Downstream| C([Hydro Power Plant]):::table
    C --> D([Turbine]):::table    
    classDef table fill:#CD88
    classDef main fill:#268073,color:white
```


```{r}
#| label: tbl-obstruction
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| html-table-processing: none


# dam_ob <-dbGetQuery(con_diaspara, "SELECT 
# * FROM dam_france.obstruction limit 100;")

# save(dam_ob, file="data/presentation_dam_ob.Rdata")
load(file="data/presentation_dam_ob.Rdata")

 dam_ob |> 
 DT::datatable(rownames = FALSE,
  options = list(
    pageLength = 5,        
    scrollX= TRUE   
  )
)|>
  htmltools::tagList(
   

     htmltools::tags$style(HTML("
      /* Table cells */
      table.dataTable td {
        font-size: 0.6em;
      }

      /* Table headers */
      table.dataTable th {
        font-size: 0.65em;
      }

      /* Control bar: search input, pagination, etc. */
      .dataTables_wrapper .dataTables_filter,
      .dataTables_wrapper .dataTables_length,
      .dataTables_wrapper .dataTables_info,
      .dataTables_wrapper .dataTables_paginate {
        font-size: 0.70em;
      }
    "))

  )

```

# Assessment of passability

The table (@tbl-fishway) is called fishway but in practise refers to fish passage, as it evaluates for each species whether the dam is passable, and this is often related to an expertise of fishway type. Basically it says whether a fishway is efficient for each species, a fishway designed for Salmon might not be suitable for Shad (@fig-dam_db_fp).

```{mermaid}
%%| label: fig-dam_db_fp
%%| fig-cap: Simplied structure of the dam database, assessment of passability 
flowchart TB
    A([Obstruction place]):::table
    %% Short Path
    A --> B([Obstruction]):::table
    B -->|Upstream| F([fish passage]):::main
    B -->|Downstream| C([Hydro Power Plant]):::table
    C --> D([Turbine]):::table    
    classDef table fill:#CD88
    classDef main fill:#268073,color:white
```



```{r}
#| label: tbl-fishway
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| html-table-processing: none


 dam_fi <-dbGetQuery(con_diaspara, "SELECT 
 fi_id_original, 
 species.no_name,
 fi_presence_pass,
 fi_date
  FROM dam_france.fishway  
  JOIN nomenclature.species on species.no_id=fi_species_id
  limit 100;")

 save(dam_fi, file="data/presentation_dam_fi.Rdata")
load(file="data/presentation_dam_fi.Rdata")

 dam_fi |> 
 DT::datatable(rownames = FALSE,
  options = list(
    pageLength = 5,        
    scrollX= TRUE   
  )
)|>
  htmltools::tagList(
   

     htmltools::tags$style(HTML("
      /* Table cells */
      table.dataTable td {
        font-size: 0.6em;
      }

      /* Table headers */
      table.dataTable th {
        font-size: 0.65em;
      }

      /* Control bar: search input, pagination, etc. */
      .dataTables_wrapper .dataTables_filter,
      .dataTables_wrapper .dataTables_length,
      .dataTables_wrapper .dataTables_info,
      .dataTables_wrapper .dataTables_paginate {
        font-size: 0.70em;
      }
    "))

  )
```

# Hydro Power Plants

The elements in hydro power plants  (@fig-dam_db_hp, @tbl-hpp)  are necessary to make a calculation of the mortality
at the dam level, according to the type of turbine, equipment flow and scenarios of flows at migration. {>>should we refer to deliverable d2.2.1 from sudoang here https://sudoang.eu/wp-content/uploads/2021/04/Deliverables-2-1-1_2-2-3-French-2.pdf ?<<}

```{mermaid}
%%| label: fig-dam_db_hp
%%| fig-cap: Simplied structure of the dam database, hydro power plants
flowchart TB
    A([Obstruction place]):::table
    %% Short Path
    A --> B([Obstruction]):::table
    B -->|Upstream| F([fish passage]):::table
    B -->|Downstream| C([Hydro Power Plant]):::main
    C --> D([Turbine]):::table    
    classDef table fill:#CD88
    classDef main fill:#268073,color:white
```


```{r}
#| label: tbl-hpp
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| html-table-processing: none
#| tbl-cap: Hydropower plant table


 dam_hpp <-dbGetQuery(con_diaspara, "SELECT 
 *
  FROM dam_france.hpp   
  limit 100;")

 save(dam_hpp, file="data/presentation_dam_hpp.Rdata")
load(file="data/presentation_dam_hpp.Rdata")

 dam_hpp |> 
 DT::datatable(rownames = FALSE,
  options = list(
    pageLength = 5,        
    scrollX= TRUE   
  )
)|>
  htmltools::tagList(
   

     htmltools::tags$style(HTML("
      /* Table cells */
      table.dataTable td {
        font-size: 0.6em;
      }

      /* Table headers */
      table.dataTable th {
        font-size: 0.65em;
      }

      /* Control bar: search input, pagination, etc. */
      .dataTables_wrapper .dataTables_filter,
      .dataTables_wrapper .dataTables_length,
      .dataTables_wrapper .dataTables_info,
      .dataTables_wrapper .dataTables_paginate {
        font-size: 0.70em;
      }
    "))

  )
```

# Turbines

In addition to the data stored in the hydropower plant (@fig-dam_db_hp), the turbin
database store key characteristics of turbin that control the level of induced
mortality.


```{mermaid}
%%| label: fig-dam_db_tu
%%| fig-cap: Simplied structure of the dam database
flowchart TB
    A([Obstruction place]):::table
    %% Short Path
    A --> B([Obstruction]):::table
    B -->|Upstream| F([fish passage]):::table
    B -->|Downstream| C([Hydro Power Plant]):::table
    C --> D([Turbine]):::main    
    classDef table fill:#CD88
    classDef main fill:#268073,color:white
```



```{r}
#| label: tbl-turbines
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| html-table-processing: none
#| tbl-cap: Turbine table



#  dam_turb <-dbGetQuery(con_diaspara, "SELECT 
#  *
#   FROM dam_france.turbine  
#   limit 100;")

#  save(dam_turb, file="data/presentation_dam_turb.Rdata")
load(file="data/presentation_dam_turb.Rdata")

 dam_turb |> 
 DT::datatable(rownames = FALSE,
  options = list(
    pageLength = 5,        
    scrollX= TRUE   
  )
)|>
  htmltools::tagList(
   

     htmltools::tags$style(HTML("
      /* Table cells */
      table.dataTable td {
        font-size: 0.6em;
      }

      /* Table headers */
      table.dataTable th {
        font-size: 0.65em;
      }

      /* Control bar: search input, pagination, etc. */
      .dataTables_wrapper .dataTables_filter,
      .dataTables_wrapper .dataTables_length,
      .dataTables_wrapper .dataTables_info,
      .dataTables_wrapper .dataTables_paginate {
        font-size: 0.70em;
      }
    "))

  )
```


```{r}
#| label: tbl-turbines_type
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| html-table-processing: none
#| tbl-cap: Turbine type table


#  turb_type <-dbGetQuery(con_diaspara, "SELECT 
#  *
#   FROM nomenclature.turbine_type;")

#  save(turb_type, file="data/presentation_turb_type.Rdata")
load(file="data/presentation_turb_type.Rdata")

 turb_type |> 
 DT::datatable(rownames = FALSE,
  options = list(
    pageLength = 5,        
    scrollX= TRUE   
  )
)|>
  htmltools::tagList(
   

     htmltools::tags$style(HTML("
      /* Table cells */
      table.dataTable td {
        font-size: 0.6em;
      }

      /* Table headers */
      table.dataTable th {
        font-size: 0.65em;
      }

      /* Control bar: search input, pagination, etc. */
      .dataTables_wrapper .dataTables_filter,
      .dataTables_wrapper .dataTables_length,
      .dataTables_wrapper .dataTables_info,
      .dataTables_wrapper .dataTables_paginate {
        font-size: 0.70em;
      }
    "))

  )
```

# Annex 1 : sql code users

<details>

<summary>SQL code to create user rights </summary>

``` {.sql include="../SQL/1_users.sql"}
```

</details>






# Annex 2 : Nomenclature tables

The nomenclature has been adapted to the DIASPARA project using the vocab in
stockDB.


<details>

<summary>SQL code to create nomenclature </summary>

``` {.sql include="../SQL/2_nomenclature_structure.sql"}
```

</details>


<details>

<summary>Data in nomenclature </summary>

``` {.sql include="../SQL/3_nomenclature_data.sql"}
```

</details>

```{r}
#| label: nomenclature
#| echo: FALSE
#| eval: TRUE
#| warning: FALSE
#| results: 'asis'

tables <- dbGetQuery(con_diaspara_admin,
"SELECT * FROM information_schema.tables 
WHERE table_schema = 'nomenclature'")$table_name
tables <- tables[-match("nomenclature",tables)]

for (tt in tables){
  tab <- dbGetQuery(con_diaspara, paste0("SELECT * FROM nomenclature.",tt))
  purrr::map_chr(
    .x = list(tab),  
    function(tab){
  knitr::knit_child(input = "Diaspara_WP3.3_dam_report_flextable_child_loop.Rmd", envir = environment(), quiet = TRUE)
    }) |> cat(sep = '\n')
}



```

# Annex 3 : Dam tables

The dam db was created from the dbeel using the following script.

<details>

<summary>SQL code to transfered from the DBEEL </summary>

``` {.sql include="../SQL/5_transfer_dbeel_dam_script.sql"}
```

</details>

The postgreSQL code for creating the table is as following

<details>

<summary>SQL code to create dam structure </summary>

``` {.sql include="../SQL/4_dam_structure.sql"}
```

</details>



# Annex 4 : Country dam table example

<details>

<summary>SQL code to create france schema </summary>

``` {.sql include="../SQL/6_france_schema.sql"}
```

</details>

<details>

<summary>SQL code to import france </summary>

``` {.sql include="../SQL/7_import_france_example.sql"}
```

</details>

# Annex 5 : Database ER diagram


![Entity Relationship database dam](images/ER_diagram.png){#fig-erd fig-alt="An entity relationship diagram for the dam database"}



